/*! verify - v1.0 - 2013-09-16 10:08:32 PM
* Copyright (c) 2013 迟伤; Licensed  */
KISSY.add("gallery/verify/1.0/index",function(a,b,c){function d(){d.superclass.constructor.apply(this,arguments),this.init()}b.all;var e={required:function(a,b,c){return""===a?[!1,c?c:"\u4eb2\uff0c\u4e0d\u80fd\u4e3a\u7a7a\u3002"]:[!0]},name:function(a,b,c){return""===a?[!0]:/^[\/\u4E00-\u9FA5A-Za-z]+$/.test(a)?[!0]:[!1,c?c:"\u59d3\u540d\u53ea\u80fd\u7531\u4e2d\u6587\u6216\u82f1\u6587\u5b57\u6bcd\u7ec4\u6210\uff0c\u8bf7\u68c0\u67e5\u662f\u5426\u5b58\u5728\u5176\u5b83\u5b57\u7b26\u3002"]},length:function(a,b,c){return 0===a.length?[!0]:b[0]&&a.length<b[0]?[!1,c?c:"\u4eb2\uff0c\u957f\u5ea6\u81f3\u5c11\u9700\u8981"+b[0]+"\u3002"]:b[1]&&a.length>b[1]?[!1,c?c:"\u4eb2\uff0c\u957f\u5ea6\u6700\u591a\u4e0d\u80fd\u8d85\u8fc7"+b[1]+"\u3002"]:[!0]},email:function(a,b,c){return""===a?[!0]:/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/.test(a)?[!0]:[!1,c?c:"\u4eb2\uff0c\u8bf7\u8f93\u5165\u6b63\u786e\u7684email\u683c\u5f0f\u3002"]},english:function(a,b,c){return/^[A-Za-z]+$/.test(a)?[!0]:[!1,c?c:"\u4eb2\uff0c\u8fd9\u91cc\u53ea\u80fd\u8f93\u5165\u82f1\u6587\u5b57\u6bcd\u3002"]},mobile:function(a,b,c){return/^[0-9\-]*$/.test(a)?[!0]:[!1,c?c:"\u624b\u673a\u53f7\u7801\u5fc5\u987b\u4e3a\u6570\u5b57\u3002"]},range:function(b,c,d){var e=c[0],f=c[1],g=d?d:"\u4eb2\uff0c\u53ea\u80fd\u5728{min}\u81f3{max}\u4e4b\u95f4\u3002";return e&&e>b||f&&b>f?[!1,a.substitute(g,{min:e,max:f})]:[!0]},number:function(a,b,c){return""===a?[!0]:/^\d+$/.test(a)?[!0]:[!1,c?c:"\u4eb2\uff0c\u53ea\u80fd\u8f93\u5165\u6570\u5b57\u3002"]},date:function(a,b,c){return/^(\d{4})(-|\/)(\d{2})\2(\d{2})$/.test(a)?[!0]:[!1,c?c:"\u8bf7\u586b\u5199\u6b63\u786e\u7684\u65e5\u671f\u683c\u5f0f\uff1aYYYY-MM-DD\u3002"]},pattern:function(a,b,c){return new RegExp(b[0]).test(a)?[!0]:[!1,c?c:"\u4eb2\uff0c\u8f93\u5165\u683c\u5f0f\u6709\u8bef\u3002"]}};return a.extend(d,c,{init:function(){var a=this;a.publish("verify"),a.publish("fail"),a._bindEvent()},_bindEvent:function(){var b=this,c=b.get("autoVerify"),d=b.get("fields"),e=b.get("nodeFn");c&&a.each(d,function(a,c){var d=e(c);d&&(d.on("change",function(){b.verify(c)}),d.on("blur",function(){""==d.val()&&b.verify(c)}))}),b.on("verify",function(a){var c=a.field,d=a.succeed,e=a.info;b._afterVerify(c,d,e)}),b.on("fail",function(a){var c=a.field,d=a.info;b.error(c,d)})},_afterVerify:function(a,b,c){var d=this;b?d.reset(a):d.fire("fail",{field:a,info:c})},_getFunctionName:function(a){return"string"==typeof a.name?a.name:/function\s+([^\{\(\s]+)/.test(a.toString())?RegExp.$1:"[Unknown]"},validate:function(b){var c=this,d=c.get("fields"),e=null,f={succeed:!0,results:[]},g={};if("undefined"==typeof b)g=d;else if(a.isString(b)){var h=d[b];if(!h)return f;g[b]=h}else a.isArray(b)&&a.each(b,function(a){g[a]=d[a]});return a.each(g,function(a,b){var d=c._verify(b,a);d.succeed||(f.succeed=!1),d.succeed||e||(e=d),f.results.push(d)}),e&&(f.firstError=e),f},_verify:function(b,c){function d(b,c){var d={};return a.each(b,function(a,b){d[a]=c[b]}),d}var f=this,g=f.get("valueFn"),h=f.get("disabled"),i=g.call(this,b),j={field:b,succeed:!0,results:[]},k=[],l=j.results,m=null,n="",o=null;if(h[b])return j;for(var p=0,q=c.length;q>p;p++){var m=c[p];if(a.isArray(m)?(n=m[0],o=m[m.length-1],k=e[n](i,m.slice(1,m.length),o)):a.isFunction(m)?(n=f._getFunctionName(m),k=m(i)):(n=m,k=e[m](i)),k=d(["rule","value","succeed","info"],[n,i].concat(k)),l.push(k),j.info=k.info,j.succeed=k.succeed,!k.succeed)break}return f.fire("verify",j),j},add:function(a,b){var c=this,d=c.get("fields");d[a]=b},remove:function(a){var b=this,c=b.get("fields");delete c[a]},modify:function(a){var b=this;b.add(a,val)},disable:function(a,b){var c=this,d=c.get("disabled");d[a]=b},error:function(b,c){function d(){g.hasClass("validationError")&&e._hideOtherTips(i)}var e=this,f=e.get("nodeFn"),g=f(b),h=e.get("state"),i=h[b];if(i||(i=h[b]={name:b,node:g}),i.info=c,!i.errorWraper){var j=g.parent(".verify-wrap");j||(a.DOM.wrap(g,a.DOM.create('<span class="verify-wrap"/>')),j=g.parent(".verify-wrap")),i.errorWraper=j}g.addClass("validationError").removeClass("validationNormal"),e._showTip(i),"text"===g.prop("type")&&(i.event||(i.event=g.on("focus",d)))},reset:function(b){var c=this,d=c.get("fields");"undefined"==typeof b?a.each(d,function(a,b){c._reset(b)}):c._reset(b)},_reset:function(a){var b=this,c=b.get("nodeFn"),d=b.get("state"),e=c(a);if(e){var f=d[a];e.removeClass("validationError").addClass("validationNormal"),f&&(b._hideTips(f),b._hideIcon(f),f=null)}},_hideTips:function(b){var c=this,d=c.get("state");"undefined"==typeof b?a.each(d,function(a){c._hideTip(a)}):c._hideTip(b)},_hideTip:function(a){var b=this;b._showIcon(a),a.errorTip&&a.errorTip.addClass("hidden")},_showTip:function(a){var b=this;if(!a.errorTip){var c=b.get("errorTipTpl");a.errorWraper.append(c),a.errorTip=a.errorWraper.one(".J_ErrorValidation"),a.infoWraper=a.errorTip.one(".J_InfoContainer");var d=a.node,e=d.outerWidth();a.errorTip.css({left:e})}a.infoWraper.html(a.info),a.errorTip.removeClass("hidden"),b._hideIcon(a)},_hideIcon:function(a){var b=this,c=b.get("errorClass");a&&a.errorWraper&&a.errorWraper.removeClass(c)},_showIcon:function(a){var b=this,c=b.get("errorClass");a&&a.errorWraper&&a.errorWraper.one(".validationError")&&a.errorWraper.addClass(c)},_hideOtherTips:function(b){var c=this,d=c.get("state");a.later(function(){a.each(d,function(a){a.name===b.name?c._showTip(a):c._hideTips(a)})},50,!1,this)},destroy:function(){var a=this;a.set("state",null),a.set("fields",null)}},{ATTRS:{fields:{value:{}},nodeFn:{value:function(b){return a.one("#"+b)}},valueFn:{value:function(a){var b=this.get("nodeFn"),c=b(a),d=c&&c.val();return d?d:""}},disabled:{value:{}},state:{value:{}},errorClass:{value:"verify-wrap-error"},autoVerify:{value:!0},errorTipTpl:{value:'<div class="verify-errortip hidden verify-errortip-left J_ErrorValidation"><em class=" tooltip-arrow tooltip-arrow-left tooltip-arrow-horizontal-left" style="top: 6.8px;"></em><span class="tooltip-close"></span><span class="tooltip-confirm"></span><div class="content-box J_InfoContainer"></div></div>'}}}),d},{requires:["node","base","./index.css"]});